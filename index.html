<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AutoVision Notebook Generator — Refined</title>
<style>
  :root{
    --bg:#ffffff; --panel:#f7f7f8; --card:#ffffff; --muted:#666; --text:#0b0b0b;
    --accent: #b91c1c; /* red accent */
    --code-bg:#111111; --code-text:#e6e6e6; --border: #e6e6e6;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b0b0b; --panel:#111216; --card:#0f1113; --muted:#9aa3ac; --text:#e6eef3;
      --accent: #ff6666;
      --code-bg:#0b0b0b; --code-text:#e6e6e6; --border: #202226;
    }
  }

  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent), var(--bg);
    color:var(--text); min-height:100vh; padding:18px;
  }

  .app{
    max-width:1400px; margin:0 auto; border-radius:12px; overflow:hidden;
    box-shadow: 0 10px 40px rgba(2,6,23,0.12);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  }

  header{
    padding:22px 28px; display:flex; gap:16px; align-items:center; border-bottom:1px solid var(--border);
    background: linear-gradient(90deg, rgba(0,0,0,0.02), transparent);
  }
  header h1{font-size:18px; margin:0; letter-spacing:0.2px}
  header p{margin:0; color:var(--muted); font-size:13px}

  .content { display:flex; gap:0; height: calc(100vh - 120px); }

  /* LEFT */
  .left { width:420px; background:var(--panel); padding:18px; overflow:auto; border-right:1px solid var(--border);}
  .card { background:var(--card); border-radius:10px; padding:14px; margin-bottom:14px; box-shadow: 0 4px 14px rgba(2,6,23,0.04); border:1px solid transparent;}
  .card .head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .card .head h3{ margin:0; font-size:13px; color:var(--accent)}
  .controls { display:flex; gap:8px }
  .btn { border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px}
  .btn-prim{ background:var(--accent); color:white; box-shadow: 0 6px 14px rgba(0,0,0,0.08)}
  .btn-ghost{ background:transparent; border:1px solid var(--border); color:var(--text)}
  .muted{ color:var(--muted); font-size:13px }

  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px }
  input[type="text"], select, textarea, input[type="number"]{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border);
    background:transparent; color:var(--text); font-size:14px;
  }
  .row{ display:flex; gap:10px }
  .small{ width:140px }

  .tog { display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
  .switch { width:44px; height:24px; background:#ccc; border-radius:999px; position:relative; display:inline-block }
  .switch .dot{ width:18px;height:18px;background:white;border-radius:50%;position:absolute; left:3px;top:3px; transition:0.18s}
  .switch.on{ background:var(--accent) }
  .switch.on .dot{ transform:translateX(20px) }

  /* RIGHT */
  .right { flex:1; padding:18px; background: linear-gradient(180deg, rgba(0,0,0,0.01), transparent); overflow:auto; }
  .previewTop { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px }
  .previewTop .info { color:var(--muted); font-size:13px }
  .cells { display:block; }
  .cell { background:var(--code-bg); border-radius:10px; padding:12px; margin-bottom:12px; border-left:4px solid var(--accent);
         color:var(--code-text); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; position:relative; white-space:pre-wrap; }
  .cell.markdown { border-left-color: #2aa198; background: linear-gradient(0deg, rgba(255,255,255,0.02), transparent) }
  .cell .label { position:absolute; right:12px; top:8px; font-size:12px; color:var(--muted) }
  .cell .toolbar { position:absolute; left:10px; top:8px; display:flex; gap:6px }
  .cell .tool { background:transparent; border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:6px; cursor:pointer; font-size:12px }
  .cell[contenteditable="true"]{ outline: none; border: 1px dashed rgba(255,255,255,0.04); padding:10px 12px; }

  .empty { text-align:center; color:var(--muted); padding:60px 20px; border-radius:8px; border:1px dashed var(--border) }

  footer.controls { display:flex; gap:10px; align-items:center; margin-top:8px; }
  .ai-btn { background:transparent; border:1px solid var(--accent); color:var(--accent); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700 }
  .danger{ background:#e53935; color:white }

  /* small responsiveness */
  @media (max-width:880px){
    .left{ width:100%; height:auto; position:sticky; top:0; z-index:12 }
    .content{ flex-direction:column }
    .right{ height:60vh }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="flex:1">
      <h1>AutoVision Notebook Generator</h1>
      <p style="margin-top:6px" class="muted">Interactive notebook composer — choose, refine, download. AI Touch optional.</p>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="muted">Theme: system</div>
      <button class="btn btn-ghost" onclick="openAbout()">About</button>
    </div>
  </header>

  <div class="content">
    <!-- LEFT -->
    <aside class="left">
      <!-- Project -->
      <div class="card" id="card-project">
        <div class="head">
          <h3>Project Info</h3>
          <div class="controls">
            <button class="btn btn-prim" onclick="generateSection('project')">Generate</button>
            <button class="btn btn-ghost" onclick="clearSection('project')">Clear</button>
          </div>
        </div>
        <label>Project Title</label>
        <input id="projectTitle" type="text" value="AutoVision_Project">
        <label style="margin-top:8px">Author</label>
        <input id="author" type="text" value="User">
        <div style="display:flex;gap:10px;margin-top:10px">
          <div style="flex:1">
            <label>Notebook Style</label>
            <select id="notebookStyle"><option value="minimal">Minimal</option><option value="educational">Educational</option><option value="technical">Technical</option></select>
          </div>
          <div style="width:150px">
            <label>Output</label>
            <select id="outputPlatform"><option value="download">Download</option><option value="colab">Colab</option><option value="kaggle">Kaggle</option></select>
          </div>
        </div>
      </div>

      <!-- Task -->
      <div class="card" id="card-task">
        <div class="head">
          <h3>Task Type</h3>
          <div class="controls">
            <button class="btn btn-prim" onclick="generateSection('task')">Generate</button>
            <button class="btn btn-ghost" onclick="clearSection('task')">Clear</button>
          </div>
        </div>
        <label>Task</label>
        <select id="task" onchange="updateSubtasks()">
          <option value="classification">Image Classification</option>
          <option value="detection">Object Detection</option>
          <option value="segmentation">Segmentation</option>
          <option value="generation">Image Generation</option>
          <option value="video">Video Analysis</option>
        </select>
        <label style="margin-top:8px">Subtask</label>
        <select id="subtask"><option>single</option></select>
      </div>

      <!-- Model -->
      <div class="card" id="card-model">
        <div class="head">
          <h3>Model Setup</h3>
          <div class="controls">
            <button class="btn btn-prim" onclick="generateSection('model')">Generate</button>
            <button class="btn btn-ghost" onclick="clearSection('model')">Clear</button>
          </div>
        </div>

        <label>Framework</label>
        <select id="framework" onchange="updateModelNames()"><option value="pytorch">PyTorch</option><option value="tensorflow">TensorFlow</option><option value="ultralytics">Ultralytics</option></select>

        <label style="margin-top:8px">Family</label>
        <select id="modelFamily" onchange="updateModelNames()">
          <option value="resnet">ResNet</option><option value="mobilenet">MobileNet</option><option value="efficientnet">EfficientNet</option><option value="yolo">YOLO</option><option value="vit">ViT</option><option value="diffusion">Diffusion</option>
        </select>

        <label style="margin-top:8px">Model</label>
        <select id="modelName"></select>

        <div style="display:flex;gap:10px;margin-top:8px">
          <div style="flex:1">
            <label>Version</label>
            <input id="modelVersion" type="text" value="v1">
          </div>
          <div style="width:120px">
            <label>Mode</label>
            <select id="mode"><option value="train">Train</option><option value="inference">Inference</option><option value="finetune">Fine-tune</option></select>
          </div>
        </div>

        <label style="margin-top:8px">Model Source</label>
        <select id="modelSource" onchange="toggleCustom()"><option value="pretrained">Pre-trained</option><option value="custom">Custom Weights</option><option value="scratch">From Scratch</option></select>
        <div id="customGroup" style="margin-top:8px;display:none">
          <label>Custom Weights Path</label>
          <input id="customWeightsPath" type="text" placeholder="/path/to/weights.pth">
        </div>
      </div>

      <!-- Preprocessing -->
      <div class="card" id="card-preprocess">
        <div class="head">
          <h3>Preprocessing</h3>
          <div class="controls">
            <button class="btn btn-prim" onclick="generateSection('preprocess')">Generate</button>
            <button class="btn btn-ghost" onclick="clearSection('preprocess')">Clear</button>
          </div>
        </div>
        <label>Image Size</label>
        <input id="imageSize" type="number" value="224">
        <div style="display:flex;gap:8px;margin-top:8px">
          <div class="tog" onclick="toggle('normalize')"><div id="sw-normalize" class="switch on"><div class="dot"></div></div><div class="muted">Normalize</div></div>
          <div class="tog" onclick="toggle('augment')"><div id="sw-augment" class="switch on"><div class="dot"></div></div><div class="muted">Augment</div></div>
          <div class="tog" onclick="toggle('adv')"><div id="sw-adv" class="switch"><div class="dot"></div></div><div class="muted">Advanced</div></div>
        </div>
      </div>

      <!-- Dataset -->
      <div class="card" id="card-dataset">
        <div class="head">
          <h3>Dataset</h3>
          <div class="controls">
            <button class="btn btn-prim" onclick="generateSection('dataset')">Generate</button>
            <button class="btn btn-ghost" onclick="clearSection('dataset')">Clear</button>
          </div>
        </div>
        <label>Source</label>
        <select id="datasetSource"><option value="kaggle">Kaggle</option><option value="local">Local</option><option value="hf">HuggingFace</option><option value="url">URL</option></select>
        <label style="margin-top:8px">Format</label>
        <select id="datasetFormat"><option value="imagefolder">ImageFolder</option><option value="coco">COCO</option><option value="yolo">YOLO</option><option value="csv">CSV</option></select>
        <label style="margin-top:8px">Path / identifier</label>
        <input id="datasetPath" type="text" placeholder="username/dataset or /path/to/data">
        <label style="margin-top:8px">Split (train/val/test)</label>
        <input id="split" type="text" value="0.8/0.1/0.1">
      </div>

      <!-- Training -->
      <div class="card" id="card-training">
        <div class="head">
          <h3>Training</h3>
          <div class="controls">
            <button class="btn btn-prim" onclick="generateSection('training')">Generate</button>
            <button class="btn btn-ghost" onclick="clearSection('training')">Clear</button>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <div style="flex:1"><label>Epochs</label><input id="epochs" type="number" value="10"></div>
          <div style="width:120px"><label>Batch</label><input id="batchSize" type="number" value="16"></div>
        </div>
        <label style="margin-top:8px">LR</label>
        <input id="lr" type="text" value="0.001">
        <label style="margin-top:8px">Optimizer</label>
        <select id="optimizer"><option value="adam">Adam</option><option value="sgd">SGD</option><option value="adamw">AdamW</option></select>
        <div style="margin-top:8px">
          <label>Scheduler</label>
          <select id="scheduler"><option value="none">None</option><option value="step">StepLR</option><option value="cosine">Cosine</option></select>
        </div>
      </div>

      <!-- Evaluation / Integrations -->
      <div class="card" id="card-eval">
        <div class="head">
          <h3>Eval & Integrations</h3>
          <div class="controls">
            <button class="btn btn-prim" onclick="generateSection('evaluation')">Generate</button>
            <button class="btn btn-ghost" onclick="clearSection('evaluation')">Clear</button>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="tog" onclick="toggle('runEval')"><div id="sw-eval" class="switch on"><div class="dot"></div></div><div class="muted">Run Eval</div></div>
          <div class="tog" onclick="toggle('visualize')"><div id="sw-vis" class="switch on"><div class="dot"></div></div><div class="muted">Visualize</div></div>
        </div>
        <div style="margin-top:8px">
          <label>Export</label>
          <select id="export"><option value="pt">.pt</option><option value="onnx">.onnx</option><option value="tflite">.tflite</option></select>
        </div>
      </div>

      <!-- Global -->
      <div class="card">
        <div class="head"><h3>Global Controls</h3><div class="controls"></div></div>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn btn-ghost" onclick="resetSettings()">Reset Settings</button>
          <button class="btn btn-ghost" onclick="clearAll()">Clear All</button>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-prim" style="flex:1" onclick="downloadNotebook()">📥 Download Notebook</button>
          <button class="ai-btn" id="aiTouchBtn" onclick="aiTouch()">✨ AI Touch</button>
        </div>
        <div style="margin-top:10px;color:var(--muted);font-size:13px">AI Touch is optional — it polishes generated notebook cells. No model called by default.</div>
      </div>
    </aside>

    <!-- RIGHT -->
    <main class="right">
      <div class="previewTop">
        <div>
          <strong style="font-size:15px">Notebook Preview</strong>
          <div class="muted" style="margin-top:6px">Generated cells appear here. Click a cell to edit — edits are preserved.</div>
        </div>
        <div class="info muted">Cells: <span id="cellCount">0</span></div>
      </div>

      <div class="cells" id="cells"></div>

      <div id="empty" class="empty" style="display:block">
        <div style="font-size:16px;margin-bottom:6px">No cells yet</div>
        <div class="muted">Use the Generate buttons on the left to add code/markdown. Edit inline, then download .ipynb.</div>
      </div>
    </main>
  </div>
</div>

<script>
/* =========================
   Notebook generator logic
   ========================= */

const notebookCells = []; // array of cell objects: {id,type,content,section,edited}
const templates = {
  project: (cfg)=>({
    cells:[
      {id:'project_md', type:'markdown', content:`# ${cfg.projectTitle}\n**Author:** ${cfg.author}\n**Generated:** ${new Date().toISOString().split('T')[0]}\n\nThis notebook was generated with AutoVision.`},
      {id:'imports', type:'code', content:`# Essential imports\nimport torch\nimport torchvision\nfrom torchvision import transforms, models, datasets\nimport torch.nn as nn\nimport torch.optim as optim\nfrom torch.utils.data import DataLoader\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom pathlib import Path\n\n# device\ndevice = torch.device('cuda' if torch.cuda.is_available() else 'cpu')\nprint('Using', device)` }
    ]
  }),
  task: (cfg)=>({
    cells:[
      {id:'task_md', type:'markdown', content:`## Task\n- Task: ${cfg.task}\n- Subtask: ${cfg.subtask}`},
      {id:'task_cfg', type:'code', content:`# Task config\nTASK='${cfg.task}'\nSUBTASK='${cfg.subtask}'\nprint('Task:', TASK, SUBTASK)` }
    ]
  }),
  model: (cfg)=>({
    cells:[
      {id:'model_md', type:'markdown', content:`## Model Setup\n- Framework: ${cfg.framework}\n- Model: ${cfg.modelName} (${cfg.modelVersion})\n- Source: ${cfg.modelSource}`},
      {id:'model_code', type:'code', content: (() => {
        if(cfg.modelSource==='pretrained'){
          // lightweight default
          if(cfg.framework==='pytorch'){
            return `# Load pretrained model (PyTorch)\nfrom torchvision import models\nmodel = models.${cfg.modelName}(weights='IMAGENET1K_V1')\nnum_features = model.fc.in_features\nnum_classes = 10  # adjust\nmodel.fc = nn.Linear(num_features, num_classes)\nmodel = model.to(device)\nprint(model)\n`;
          } else if(cfg.framework==='ultralytics'){
            return `# YOLO style (placeholder)\n# from ultralytics import YOLO\n# model = YOLO('${cfg.modelName}.pt')\n# model.predict(...)\n`;
          }
        } else if(cfg.modelSource==='custom'){
          return `# Load custom weights\nfrom torchvision import models\nmodel = models.${cfg.modelName}(weights=None)\nnum_features = model.fc.in_features\nmodel.fc = nn.Linear(num_features, 10)\ncheckpoint = torch.load('${cfg.customWeightsPath}', map_location=device)\nmodel.load_state_dict(checkpoint.get('model_state_dict', checkpoint))\nmodel = model.to(device)\nprint('Loaded custom weights')\n`;
        }
        return `# Initialize from scratch\nfrom torchvision import models\nmodel = models.${cfg.modelName}(weights=None)\nnum_features = model.fc.in_features\nmodel.fc = nn.Linear(num_features, 10)\nmodel = model.to(device)\nprint('Model initialized')\n`;
      })() }
    ]
  }),
  preprocess: (cfg)=>({
    cells:[
      {id:'pre_md', type:'markdown', content:`## Preprocessing\n- Image size: ${cfg.imageSize}\n- Normalize: ${cfg.normalize}\n- Augment: ${cfg.augment}\n- Advanced: ${cfg.adv}`},
      {id:'pre_code', type:'code', content: (() => {
        const lines = [];
        lines.push(`# Transforms`);
        lines.push(`from torchvision import transforms`);
        lines.push(`train_transform = transforms.Compose([`);
        lines.push(`  transforms.Resize((${cfg.imageSize}, ${cfg.imageSize})),`);
        if(cfg.augment) {
          lines.push(`  transforms.RandomHorizontalFlip(),`);
          lines.push(`  transforms.ColorJitter(brightness=0.2, contrast=0.2),`);
        }
        if(cfg.adv) {
          lines.push(`  transforms.RandomRotation(10),`);
        }
        lines.push(`  transforms.ToTensor(),`);
        if(cfg.normalize) lines.push(`  transforms.Normalize([0.485,0.456,0.406],[0.229,0.224,0.225]),`);
        lines.push(`])`);
        lines.push(`\nval_transform = transforms.Compose([\n  transforms.Resize((${cfg.imageSize}, ${cfg.imageSize})),\n  transforms.ToTensor(),\n  ${cfg.normalize? "transforms.Normalize([0.485,0.456,0.406],[0.229,0.224,0.225]),": ""}\n])`);
        return lines.join('\n');
      })() }
    ]
  }),
  dataset: (cfg)=>({
    cells:[
      {id:'data_md', type:'markdown', content:`## Dataset\n- Source: ${cfg.datasetSource}\n- Format: ${cfg.datasetFormat}\n- Path: ${cfg.datasetPath}\n- Split: ${cfg.split}`},
      {id:'data_code', type:'code', content: (() => {
        if(cfg.datasetSource==='kaggle'){
          return `# Kaggle dataset (ensure kaggle.json exists)\n!pip install -q kaggle\nfrom kaggle.api.kaggle_api_extended import KaggleApi\napi = KaggleApi(); api.authenticate()\napi.dataset_download_files('${cfg.datasetPath}', path='./data', unzip=True)\ndata_dir = Path('data')\n`;
        } else if(cfg.datasetSource==='hf'){
          return `# HuggingFace dataset\nfrom datasets import load_dataset\ndataset = load_dataset('${cfg.datasetPath}')\n`;
        } else if(cfg.datasetSource==='url'){
          return `# Download and extract\nimport urllib.request, zipfile\nurl='${cfg.datasetPath}'\nurllib.request.urlretrieve(url,'dataset.zip')\nwith zipfile.ZipFile('dataset.zip','r') as z: z.extractall('data')\n`;
        } else {
          return `# Local dataset\nfrom pathlib import Path\ndata_dir = Path('${cfg.datasetPath}')\n`;
        }
      })() }
    ]
  }),
  training: (cfg)=>({
    cells:[
      {id:'train_md', type:'markdown', content:`## Training\n- Epochs: ${cfg.epochs}\n- Batch: ${cfg.batchSize}\n- LR: ${cfg.lr}\n- Optimizer: ${cfg.optimizer}\n- Scheduler: ${cfg.scheduler}`},
      {id:'train_code', type:'code', content: (() => {
        return `# Training loop (simple)\ncriterion = nn.CrossEntropyLoss()\noptimizer = optim.Adam(model.parameters(), lr=${cfg.lr})\n# dataloaders: train_loader, val_loader expected\nfor epoch in range(${cfg.epochs}):\n  model.train()\n  for xb, yb in train_loader:\n    xb,yb = xb.to(device), yb.to(device)\n    optimizer.zero_grad()\n    out = model(xb)\n    loss = criterion(out,yb)\n    loss.backward()\n    optimizer.step()\n  print('Epoch', epoch+1)\n`;
      })() }
    ]
  }),
  evaluation: (cfg)=>({
    cells:[
      {id:'eval_md', type:'markdown', content:`## Evaluation & Export\n- RunEval: ${cfg.runEval}\n- Visualize: ${cfg.visualize}\n- Export: ${cfg.export}`},
      {id:'eval_code', type:'code', content: (() => {
        const parts = [];
        if(cfg.runEval) {
          parts.push(`# Evaluate (using val_loader)\nfrom sklearn.metrics import classification_report\nmodel.eval()\n# iterate and compute metrics...`);
        }
        if(cfg.visualize) {
          parts.push(`# Visualize predictions\n# visualize code here`);
        }
        if(cfg.export==='onnx') {
          parts.push(`# Export to ONNX\ndummy = torch.randn(1,3,${cfg.imageSize},${cfg.imageSize}).to(device)\ntorch.onnx.export(model, dummy, 'model.onnx')`);
        } else if(cfg.export==='pt') {
          parts.push(`torch.save({'model_state_dict': model.state_dict()}, 'best_model.pth')\nprint('Saved best_model.pth')`);
        }
        return parts.join('\n\n');
      })() }
    ]
  })
};

/* Utilities */
function getConfig(){
  return {
    projectTitle: document.getElementById('projectTitle').value.trim() || 'AutoVision_Project',
    author: document.getElementById('author').value.trim() || 'User',
    notebookStyle: document.getElementById('notebookStyle').value,
    outputPlatform: document.getElementById('outputPlatform').value,

    task: document.getElementById('task').value,
    subtask: document.getElementById('subtask').value,

    framework: document.getElementById('framework').value,
    modelFamily: document.getElementById('modelFamily').value,
    modelName: document.getElementById('modelName').value,
    modelVersion: document.getElementById('modelVersion').value,
    mode: document.getElementById('mode').value,
    modelSource: document.getElementById('modelSource').value,
    customWeightsPath: document.getElementById('customWeightsPath').value,

    imageSize: Number(document.getElementById('imageSize').value) || 224,
    normalize: document.getElementById('sw-normalize').classList.contains('on'),
    augment: document.getElementById('sw-augment').classList.contains('on'),
    adv: document.getElementById('sw-adv').classList.contains('on'),

    datasetSource: document.getElementById('datasetSource').value,
    datasetFormat: document.getElementById('datasetFormat').value,
    datasetPath: document.getElementById('datasetPath').value,
    split: document.getElementById('split').value,

    epochs: Number(document.getElementById('epochs').value) || 10,
    batchSize: Number(document.getElementById('batchSize').value) || 16,
    lr: document.getElementById('lr').value,
    optimizer: document.getElementById('optimizer').value,
    scheduler: document.getElementById('scheduler').value,

    runEval: document.getElementById('sw-eval').classList.contains('on'),
    visualize: document.getElementById('sw-vis').classList.contains('on'),
    export: document.getElementById('export').value
  };
}

/* Render UI cells */
function renderCells(){
  const container = document.getElementById('cells');
  container.innerHTML='';
  if(notebookCells.length===0){
    document.getElementById('empty').style.display='block';
  } else {
    document.getElementById('empty').style.display='none';
  }
  notebookCells.forEach((c, idx)=>{
    const el = document.createElement('div');
    el.className = 'cell' + (c.type==='markdown' ? ' markdown' : '');
    el.setAttribute('data-id', c.id);
    el.setAttribute('contenteditable', c.editable? 'true' : 'true'); // editable always
    // toolbar
    const toolbar = document.createElement('div'); toolbar.className='toolbar';
    const btnSave = document.createElement('button'); btnSave.className='tool'; btnSave.textContent='Save'; btnSave.onclick=(e)=>{ e.stopPropagation(); saveCellEdit(c.id); };
    const btnRegen = document.createElement('button'); btnRegen.className='tool'; btnRegen.textContent='Regenerate'; btnRegen.onclick=(e)=>{ e.stopPropagation(); regenerateCell(c.section,c.id); };
    const btnRemove = document.createElement('button'); btnRemove.className='tool'; btnRemove.textContent='Remove'; btnRemove.onclick=(e)=>{ e.stopPropagation(); removeCell(c.id); };
    toolbar.appendChild(btnSave); toolbar.appendChild(btnRegen); toolbar.appendChild(btnRemove);
    el.appendChild(toolbar);

    const label = document.createElement('div'); label.className='label'; label.textContent = c.type === 'markdown' ? 'Markdown' : 'Code';
    el.appendChild(label);

    const pre = document.createElement('pre'); pre.style.marginTop='26px';
    pre.textContent = c.content;
    pre.onclick = ()=>{ el.setAttribute('contenteditable','true'); };
    // when user edits in place, mark edited flag
    pre.addEventListener('input', ()=>{ markEdited(c.id, el.innerText || el.textContent); });
    // set initial content
    el.appendChild(pre);
    container.appendChild(el);
  });
  document.getElementById('cellCount').textContent = notebookCells.length;
}

/* helpers: find index by id */
function findIndexById(id){ return notebookCells.findIndex(x => x.id===id); }

/* mark edited: update content and flag */
function markEdited(id, newContent){
  const i = findIndexById(id); if(i<0) return;
  notebookCells[i].content = newContent;
  notebookCells[i].edited = true;
  renderCells();
}

/* save cell edit manually (re-reads DOM) */
function saveCellEdit(id){
  const idx = findIndexById(id); if(idx<0) return;
  const el = document.querySelector(`[data-id="${id}"]`);
  if(!el) return;
  const text = el.innerText || el.textContent;
  notebookCells[idx].content = text;
  notebookCells[idx].edited = true;
  renderCells();
}

/* regenerate a single cell from templates (if exists) - only if not edited */
function regenerateCell(section, cellId){
  const cfg = getConfig();
  if(!templates[section]) return;
  const newCells = templates[section](cfg).cells;
  const found = newCells.find(nc=>nc.id===cellId);
  if(!found) return alert('Template cell not available for regen');
  const idx = findIndexById(cellId);
  if(idx>=0 && notebookCells[idx].edited){
    if(!confirm('This cell has local edits. Overwrite?')) return;
  }
  const newObj = {...found, section, edited:false};
  if(idx>=0) notebookCells.splice(idx,1,newObj);
  else notebookCells.push(newObj);
  renderCells();
}

/* remove cell */
function removeCell(id){
  const idx = findIndexById(id); if(idx<0) return;
  notebookCells.splice(idx,1);
  renderCells();
}

/* Clear section */
function clearSection(section){
  for(let i=notebookCells.length-1;i>=0;i--){ if(notebookCells[i].section===section) notebookCells.splice(i,1); }
  renderCells();
}

/* Generate section - preserves edited cells in same section (match by id) */
function generateSection(section){
  const cfg = getConfig();
  if(!templates[section]) { alert('No template for '+section); return; }
  const newCells = templates[section](cfg).cells.map(c=>({ ...c, section, edited:false }));
  // remove non-edited cells of that section, but keep edited ones
  const keep = notebookCells.filter(c => !(c.section===section && !c.edited));
  // merge: for each new cell, if there's an edited with same id, keep edited instead of new
  newCells.forEach(nc=>{
    const editedExisting = notebookCells.find(c=>c.id===nc.id && c.section===section && c.edited);
    if(editedExisting){
      keep.push(editedExisting);
    } else {
      keep.push(nc);
    }
  });
  // also keep other sections
  const others = notebookCells.filter(c=>c.section!==section);
  // rebuild: keep others + keep (ensuring order: others first by original order, then new of section)
  const combined = [];
  // preserve original order of all previous cells for sections not regenerated
  notebookCells.forEach(c=>{
    if(c.section!==section) combined.push(c);
  });
  // then append section cells in newCells order, but prefer editedExisting
  newCells.forEach(nc=>{
    const editedExisting = notebookCells.find(c=>c.id===nc.id && c.section===section && c.edited);
    combined.push(editedExisting ? editedExisting : nc);
  });
  // replace
  notebookCells.length=0; notebookCells.push(...combined);
  renderCells();
}

/* reset / clear all */
function resetSettings(){
  document.getElementById('projectTitle').value='AutoVision_Project';
  document.getElementById('author').value='User';
  document.getElementById('notebookStyle').value='minimal';
  document.getElementById('outputPlatform').value='download';

  document.getElementById('task').value='classification'; updateSubtasks();
  document.getElementById('framework').value='pytorch';
  document.getElementById('modelFamily').value='resnet'; updateModelNames();
  document.getElementById('modelVersion').value='v1'; document.getElementById('mode').value='train';
  document.getElementById('modelSource').value='pretrained'; toggleCustom();

  document.getElementById('imageSize').value='224';
  document.getElementById('sw-normalize').classList.add('on');
  document.getElementById('sw-augment').classList.add('on');
  document.getElementById('sw-adv').classList.remove('on');

  document.getElementById('datasetSource').value='kaggle';
  document.getElementById('datasetFormat').value='imagefolder';
  document.getElementById('datasetPath').value='';
  document.getElementById('split').value='0.8/0.1/0.1';

  document.getElementById('epochs').value='10';
  document.getElementById('batchSize').value='16';
  document.getElementById('lr').value='0.001';
  document.getElementById('optimizer').value='adam';
  document.getElementById('scheduler').value='none';

  document.getElementById('sw-eval').classList.add('on');
  document.getElementById('sw-vis').classList.add('on');
  document.getElementById('export').value='pt';
}

function clearAll(){
  if(!confirm('Clear all cells and reset settings?')) return;
  notebookCells.length=0;
  resetSettings();
  renderCells();
}

/* download notebook -> nbformat */
function downloadNotebook(){
  if(notebookCells.length===0){ alert('No cells generated'); return; }
  const cfg = getConfig();
  const nb = {
    nbformat:4, nbformat_minor:5,
    metadata: {
      kernelspec: {name:'python3', display_name:'Python 3'},
      language_info: {name:'python', version:'3.x'}
    },
    cells: notebookCells.map(c=>{
      const src = (c.content||'').split('\n').map(l=> l + '\n');
      if(c.type==='markdown') return {cell_type:'markdown', metadata:{}, source: src};
      return {cell_type:'code', execution_count: null, metadata:{}, outputs:[], source: src};
    })
  };
  const blob = new Blob([JSON.stringify(nb,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url;
  a.download = `AutoVision_${cfg.task}_${cfg.modelName || 'model'}_${Date.now()}.ipynb`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* small helpers for toggles */
function toggle(id){
  const el = document.getElementById('sw-'+id);
  if(!el) return;
  el.classList.toggle('on');
}

/* update subtasks based on task */
function updateSubtasks(){
  const t = document.getElementById('task').value;
  const sub = document.getElementById('subtask');
  const map = {
    classification:['single','multi'],
    detection:['yolo','rcnn'],
    segmentation:['semantic','instance'],
    generation:['diffusion','gan'],
    video:['action','tracking']
  };
  sub.innerHTML='';
  (map[t]||['default']).forEach(s=>{
    const opt = document.createElement('option'); opt.value=s; opt.textContent=s; sub.appendChild(opt);
  });
}

/* model name list */
function updateModelNames(){
  const family = document.getElementById('modelFamily').value;
  const sel = document.getElementById('modelName');
  const map = {
    resnet:['resnet18','resnet34','resnet50'],
    mobilenet:['mobilenet_v2','mobilenet_v3_small'],
    efficientnet:['efficientnet_b0','efficientnet_b1'],
    yolo:['yolov8n','yolov8s','yolov8m'],
    vit:['vit_b_16','vit_l_16'],
    diffusion:['stable-diffusion-v1-5','sdxl']
  };
  sel.innerHTML='';
  (map[family]||['default']).forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });
}

/* toggle custom weights UI */
function toggleCustom(){
  const src = document.getElementById('modelSource').value;
  document.getElementById('customGroup').style.display = src==='custom' ? 'block' : 'none';
}

/* AI Touch - lightweight local polish (stub) */
function aiTouch(){
  if(notebookCells.length===0){ alert('Generate some cells first'); return; }
  const instr = prompt('AI Touch — paste short instruction (example: "add clearer comments and variable names")','Polish comments and add helpful notes');
  if(instr===null) return;
  // Simple heuristic "polish": for each code cell, prepend a comment summarizing instruction and wrap long lines
  for(let i=0;i<notebookCells.length;i++){
    const c = notebookCells[i];
    if(c.type==='code'){
      if(c.edited) continue; // respect edits
      const header = `# AI Touch: ${instr}\n# Generated: ${new Date().toISOString()}\n`;
      // simple polish: ensure there is a newline after header
      c.content = header + c.content;
      c.edited = false; // still not user-edited, but we've modified it via AI Touch
    } else if(c.type==='markdown'){
      // add extra friendly sentence
      c.content = c.content + `\n\n> AI Touch note: ${instr}`;
    }
  }
  alert('AI Touch applied (local polish). Replace this with real AI call if desired.');
  renderCells();
}

/* regenerate entire section (utility) */
function regenSection(section){
  generateSection(section);
}

/* regenerate if present on load */
function init(){
  updateSubtasks(); updateModelNames(); renderCells();
  resetSettings();
}

/* expose functions for buttons */
window.generateSection = generateSection;
window.clearSection = clearSection;
window.resetSettings = resetSettings;
window.clearAll = clearAll;
window.downloadNotebook = downloadNotebook;
window.toggleCustom = toggleCustom;
window.updateSubtasks = updateSubtasks;
window.updateModelNames = updateModelNames;
window.aiTouch = aiTouch;

/* about */
function openAbout(){ alert('AutoVision Notebook Generator — refined single-file UI. AI Touch is a local stub.'); }

init();
</script>
</body>
</html>
